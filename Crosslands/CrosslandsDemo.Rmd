---
title: <span style="color:#1A5276">EnviroDIY - Crosslands Demo</span>
author: <span style="color:#85C1E9">![alt text](Limno_Swirl_no_tagline_MAP.png)</span>
subtitle: <span style="color:#424949">Live summary of measurements made in a stormwater pond in Oakdale, MN</span>
output: 
  prettydoc::html_pretty:
    theme: leonids
    highlight: github
runtime: shiny
resource_files:
- Oakdale_Sewershed.cpg
- Oakdale_Sewershed.dbf
- Oakdale_Sewershed.prj
- Oakdale_Sewershed.sbn
- Oakdale_Sewershed.sbx
- Oakdale_Sewershed.shp
- Oakdale_Sewershed.shp.xml
- Oakdale_Sewershed.shx
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(shiny)
library(knitr)
library(kableExtra)
library(ggplot2)
library(tidyverse)
library(quantmod)
library(shiny)
library(ggiraph)
library(plotly)
library(WaterML)
library(leaflet)
library(rgdal)
library(rgeos)
library(sp)
library(raster)

```

**LimnoTech** has installed an EnviroDIY site in a stormwater pond on Crosslands property. The surface area of the pond is approximately 7,500 square feet while the pond's sewershed (delineated in red on the [map](#map)) is 55 acres. The pond was constructed in between two business park developments. 





```{r echo=FALSE, warning=FALSE, include=FALSE}

server <- "http://odm2wofpy.uwrl.usu.edu:8080/odm2timeseries/soap/cuahsi_1_0/.wsdl"
info <- GetSiteInfo(server, "odm2timeseries:160065_Crosslands")
lat <- info$Latitude[1]
long <- info$Longitude[1]
sitename <- info$SiteName[1]


```

#Live Data Summary

```{r include=FALSE}
## Preload first datasets

wdepth <- GetValues(server, siteCode="odm2timeseries:160065_Crosslands", variableCode="odm2timeseries:MaxBotix_MB7386_Distance", Sys.Date()-7,endDate=Sys.Date()+2 )
bbatt <- GetValues(server, siteCode="odm2timeseries:160065_Crosslands", variableCode="odm2timeseries:EnviroDIY_Mayfly_Volt",startDate = Sys.Date()-7,endDate=Sys.Date()+2)

sensor <- "MaxBotix MB7386"
syssensor <- "Internal Mayfly Board"
```


```{r echo=FALSE, warning = FALSE}

vars <- c('Depth', 'Air Temperature', 'Water Temperature', 'Humidity','Board Temperature', 'Free RAM', 'Battery Voltage')
sensors <- c('MaxBotix MB7386', 'Seeed BME280', 'Adafruit DS18B20','Seeed BME280','Internal Mayfly Board','Internal Mayfly Board','Internal Mayfly Board')
varsens <- data.frame("measurement"=vars, "sensor"=sensors)


inputPanel(

    column(12, h4("Measurement:"),
          selectizeInput("Var", "", vars)
    )
)


sensor <- reactive({
  as.character(varsens$sensor[varsens$measurement == input$Var][1])
})



#placeholder='Please select',
#          onInitialize = I('function() {this.setValue(""); }')
#


```




```{r echo=FALSE, warning = FALSE}

renderPlotly({
  if(input$Var == "Depth"){
    tidy <- separate(wdepth, time, into=c("date", "time"), sep="T")
    tidy$datetime <- paste(tidy$date, " ", tidy$time,sep="")
    tidy$datetime <- as.POSIXct(strptime(tidy$datetime,format="%Y-%m-%d %H:%M:%S"))-11*60*60
    tidy$date <- as.POSIXct(strptime(tidy$date, format="%Y-%m-%d"))-11*60*60
    wdepth$datetime <- tidy$datetime
    wdepth$date <- tidy$date
    wdepth <- wdepth %>% filter(DataValue != 0) #keep non zero values
    wdepth <- wdepth %>% filter(DataValue != 9999) # error code from sensor
    wdepth <- wdepth %>% filter(DataValue < 4000) # 
    wdepth <- wdepth %>% filter(DataValue > 1000) # depths greater than 3 m
    wdepth$Depth = (4000 - wdepth$DataValue)/1000
    #wdepth_dmax <- wdepth %>% group_by(date) %>% summarise(maxDepth=max(Depth))
    mindate <- min(wdepth$datetime)
    maxdate <- max(wdepth$datetime)
    #range <- data.frame(date=seq.POSIXt(mindate, maxdate, by=86400))
    #wdepth <- left_join(range, wdepth_dmax, by="date") %>% 
    #  mutate(ribmin = 0) %>%
    #  mutate(ribmax = if(is.na(maxDepth),0,maxDepth))
    #wdepth$ribmin <- 0
    #wdepth <- wdepth %>% mutate(ribmax = ifelse(is.na(maxDepth),0,maxDepth))

    p <- ggplot(wdepth,aes(x=datetime, y=Depth)) + 
            geom_point(colour="#5499C7", size=0.5) +
            geom_line(colour="grey70", alpha=0.5, linetype="dotted") +
            theme_minimal() + 
            theme(panel.background = element_rect(colour=NA, fill="grey97")) + 
            xlab("Date") + 
            ylab("Water Depth (m)") +
            xlim(mindate, Sys.time())
    p
    plotly_p <- ggplotly(p, dynamicTicks=TRUE) %>% layout(margin=list(r=20, l=60, t=20, b=50))
    plotly_p
    
  } else if(input$Var == "Water Temperature"){
  
  wtemp <- GetValues(server, siteCode="odm2timeseries:160065_Crosslands", variableCode="odm2timeseries:Adafruit_DS18B20_Temp",startDate = Sys.Date()-7,endDate=Sys.Date()+2)
  tidy <- separate(wtemp, time, into=c("date", "time"), sep="T")
  tidy$datetime <- paste(tidy$date, " ", tidy$time,sep="")
  tidy$datetime <- as.POSIXct(strptime(tidy$datetime,format="%Y-%m-%d %H:%M:%S"))-11*60*60
  tidy$date <- as.POSIXct(strptime(tidy$date, format="%Y-%m-%d"))-11*60*60
  wtemp$date <- tidy$date
  wtemp$datetime <- tidy$datetime
  wtemp$DataValue <- wtemp$DataValue*9/5+32
  
  p <- ggplot(wtemp, aes(x=datetime, y=DataValue)) +
    geom_point(colour="#F5B041", size=0.5) +
    geom_line(colour="grey70",alpha=0.5, linetype="dotted") +
    theme_minimal() + 
    theme(panel.background = element_rect(colour=NA, fill="grey97")) + 
    xlab("Date") + 
    ylab("Water Temperature (Deg F)")
  p
  
  
  plotly_p <- ggplotly(p, dynamicTicks=TRUE) %>% layout(margin=list(r=20, l=60, t=20, b=50))
  plotly_p
  } else if(input$Var == "Air Temperature"){
  
  atemp <- GetValues(server, siteCode="odm2timeseries:160065_Crosslands", variableCode="odm2timeseries:Seeed_BME280_Temp",startDate = Sys.Date()-7,endDate=Sys.Date()+2)
  tidy <- separate(atemp, time, into=c("date", "time"), sep="T")
  tidy$datetime <- paste(tidy$date, " ", tidy$time,sep="")
  tidy$datetime <- as.POSIXct(strptime(tidy$datetime,format="%Y-%m-%d %H:%M:%S"))-11*60*60
  tidy$date <- as.POSIXct(strptime(tidy$date, format="%Y-%m-%d"))-11*60*60
  atemp$date <- tidy$date
  atemp$datetime <- tidy$datetime
  atemp <- filter(atemp, DataValue < 90000)
  atemp$DataValue <- atemp$DataValue*9/5+32
  
  p <- ggplot(atemp, aes(x=datetime, y=DataValue)) +
    geom_point(colour="#CD6155", size=0.5) +
    geom_line(colour="grey70",alpha=0.5, linetype="dotted") +
    theme_minimal() + 
    theme(panel.background = element_rect(colour=NA, fill="grey97")) + 
    xlab("Date") + 
    ylab("Air Temperature (Deg F)")
  p
  
  
  plotly_p <- ggplotly(p, dynamicTicks=TRUE) %>% layout(margin=list(r=20, l=60, t=20, b=50))
  plotly_p
  
  } else if(input$Var == "Humidity") {
    
  humidity <- GetValues(server, siteCode="odm2timeseries:160065_Crosslands", variableCode="odm2timeseries:Seeed_BME280_humidity", Sys.Date()-7,endDate=Sys.Date()+2)
  tidy <- separate(humidity, time, into=c("date", "time"), sep="T")
  tidy$datetime <- paste(tidy$date, " ", tidy$time,sep="")
  tidy$datetime <- as.POSIXct(strptime(tidy$datetime,format="%Y-%m-%d %H:%M:%S"))-11*60*60
  tidy$date <- as.POSIXct(strptime(tidy$date, format="%Y-%m-%d"))-11*60*60
  humidity$date <- tidy$date
  humidity$datetime <- tidy$datetime
  
  p <- ggplot(humidity, aes(x=datetime, y=DataValue)) +
    geom_point(colour="#424949", size=0.5) +
    geom_line(colour="grey70",alpha=0.5, linetype="dotted") +
    theme_minimal() + 
    theme(panel.background = element_rect(colour=NA, fill="grey97")) + 
    xlab("Date") + 
    ylab("Humidity (%)")
  p
  
  
  plotly_p <- ggplotly(p, dynamicTicks=TRUE) %>% layout(margin=list(r=20, l=60, t=20, b=50))
  plotly_p
  } 
  
  
})

```
***<span style="color:#5499C7">Sensor:</span>*** `r sensor` <br>


#Site Info
***<span style="color:#5499C7">Owner:</span>*** LimnoTech <br>
***<span style="color:#5499C7">Site Location:</span>*** Oakdale, MN <br>
***<span style="color:#5499C7">Board:</span>*** Mayfly v0.5 <br>
***<span style="color:#5499C7">First Measurement:</span>*** `r info$beginDateTime[1]-11*60*60` <br>
***<span style="color:#5499C7">Most Recent Measurement:</span>*** `r info$endDateTime[1]-11*60*60` <br>
***<span style="color:#5499C7">Sensors:</span>*** `r unique(varsens$sensor)` <br>
***<span style="color:#5499C7">Measurements:</span>*** `r varsens$measurement` <br><br>
```{r echo=FALSE, warning = FALSE, results='asis'}
kable(varsens, caption="Measurement Detail") %>%
  kable_styling(bootstrap_options = c("striped", "hover"))
```

#Site Location {#map}


```{r echo=FALSE, warning = FALSE}

marker1 <- paste0("<strong>Site Name: </strong>", info$SiteName, "<dd>", "<strong>Number of Variables: </strong>", dim(info)[1], "<dd>", "<strong>Organization: </strong>", info$organization)

sewershed <- shapefile("Oakdale_Sewershed.shp")
sewershed <- spTransform(sewershed, CRS("+init=epsg:4326"))
palshed <- colorFactor(c("#ddc5a1"), sewershed$OBJECTID)


output$map <- renderLeaflet({
  map <- leaflet() %>%
    addProviderTiles("CartoDB.Positron", group= "Light Basemap") %>%
    addTiles(urlTemplate = 'http://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}',
       attribution = 'Data source: Map data: Google, DigitalGlobe</a>', 
       options = tileOptions(maxZoom = 20, minZoom=9, subdomains=c("mt0", "mt1", "mt2", "mt3")), group="Aerial Imagery") %>%
    setView(lng = long, lat = lat, zoom=12) %>%
    addPolygons(data=sewershed, fillOpacity=0.3, smoothFactor=0.2, color="red") %>%
    addMarkers(info$Longitude[1],info$Latitude[1], popup= marker1, label=info$SiteName) %>%
    addLayersControl(
      overlayGroups = c("Aerial Imagery"), 
      options = layersControlOptions(collapsed = FALSE)) %>%
    hideGroup(c("Aerial Imagery"))
})

leafletOutput('map')

``` 


#System Status

```{r echo=FALSE, warning = FALSE}

sysvars <- c('Battery','Board Temperature', 'Free RAM')

inputPanel(

    column(12, h4("Metric:"),
          selectizeInput("Sysvar", "", sysvars)
    )
)

``` 

```{r echo=FALSE, warning = FALSE}

renderPlotly({
  if(input$Sysvar == "Battery") {
    
    tidy <- separate(bbatt, time, into=c("date", "time"), sep="T")
    tidy$datetime <- paste(tidy$date, " ", tidy$time,sep="")
    tidy$datetime <- as.POSIXct(strptime(tidy$datetime,format="%Y-%m-%d %H:%M:%S"))-11*60*60
    tidy$date <- as.POSIXct(strptime(tidy$date, format="%Y-%m-%d"))-11*60*60
    bbatt$date <- tidy$date
    bbatt$datetime <- tidy$datetime

    p2 <- ggplot(bbatt, aes(x=datetime, y=DataValue)) +
          geom_point(colour="#52BE80", size=0.5) +
          geom_line(colour="grey70",alpha=0.5, linetype="dotted") +
          theme_minimal() + 
          theme(panel.background = element_rect(colour=NA, fill="grey97")) + 
          xlab("Date") + 
          ylab("Battery Voltage (V)")
    p2
    
    plotly_p2 <- ggplotly(p2, dynamicTicks=TRUE) %>% layout(margin=list(r=20, l=60, t=20, b=50))
    plotly_p2
    
  } else if(input$Sysvar == "Board Temperature") {
    btemp <- GetValues(server, siteCode="odm2timeseries:160065_Crosslands", variableCode="odm2timeseries:EnviroDIY_Mayfly_Temp",startDate = Sys.Date()-7,endDate=Sys.Date()+2)
    
    tidy <- separate(btemp, time, into=c("date", "time"), sep="T")
    tidy$datetime <- paste(tidy$date, " ", tidy$time,sep="")
    tidy$datetime <- as.POSIXct(strptime(tidy$datetime,format="%Y-%m-%d %H:%M:%S"))-11*60*60
    tidy$date <- as.POSIXct(strptime(tidy$date, format="%Y-%m-%d"))-11*60*60
    btemp$date <- tidy$date
    btemp$datetime <- tidy$datetime
    btemp$DataValue <- btemp$DataValue*9/5+32

    p2 <- ggplot(btemp, aes(x=datetime, y=DataValue)) +
          geom_point(colour="#52BE80", size=0.5) +
          geom_line(colour="grey70",alpha=0.5, linetype="dotted") +
          theme_minimal() + 
          theme(panel.background = element_rect(colour=NA, fill="grey97")) + 
          xlab("Date") + 
          ylab("Board Temperature (Deg F)")
    p2
    
    plotly_p2 <- ggplotly(p2, dynamicTicks=TRUE) %>% layout(margin=list(r=20, l=60, t=20, b=50))
    plotly_p2
  } else if (input$Sysvar == "Free RAM") {
    
    bram <- GetValues(server, siteCode="odm2timeseries:160065_Crosslands", variableCode="odm2timeseries:EnviroDIY_Mayfly_FreeSRAM",startDate = Sys.Date()-7,endDate=Sys.Date()+2)
    
    tidy <- separate(bram, time, into=c("date", "time"), sep="T")
    tidy$datetime <- paste(tidy$date, " ", tidy$time,sep="")
    tidy$datetime <- as.POSIXct(strptime(tidy$datetime,format="%Y-%m-%d %H:%M:%S"))-11*60*60
    tidy$date <- as.POSIXct(strptime(tidy$date, format="%Y-%m-%d"))-11*60*60
    bram$date <- tidy$date
    bram$datetime <- tidy$datetime

    p2 <- ggplot(bram, aes(x=datetime, y=DataValue)) +
          geom_point(colour="#52BE80", size=0.5) +
          geom_line(colour="grey70",alpha=0.5, linetype="dotted") +
          theme_minimal() + 
          theme(panel.background = element_rect(colour=NA, fill="grey97")) + 
          xlab("Date") + 
          ylab("Free RAM (bit)")
    p2
    
    plotly_p2 <- ggplotly(p2, dynamicTicks=TRUE) %>% layout(margin=list(r=20, l=60, t=20, b=50))
    plotly_p2
    
  }
})

```
***<span style="color:#5499C7">Sensor:</span>*** `r syssensor` <br>


<img style="width:40px;height:40px;" align="right" src="Swirl_only.png"/> 


